Junzheng Zeratul development (2) - uboot startup analysis _Biao-Programmer ITS301_Junzheng sdk
tags:  Ingenuity   Uboot   system startup   Embedded Ingenuity   device development   Zeratul  

Foreword
Boot startup is generally divided into two stages. The first stage uboot spl program of Inzheng equipment is not open source. The user compiles the second stage boot. Finally, the two stages of boot are merged together and written to the boot partition. , the boot partition is as follows
insert image description here

(一)SPL (secondary program loader)
SPL (secondary program loader) is a very small bin file, which is used to boot the main u-boot file. For some SOCs with small SRAM, the bootloader in ROM cannot be loaded into SRAM at one time, because the general SRAM is much smaller than the size of the bootloader. At this time SPL came into being.


Loading process
The SOC of the embedded system has a relatively small SRAM inside, while the external one generally has DDR or SDRAM, and the latter RAM is the external RAM; the SPL will be loaded into the SRAM first, and then the DDR or SDRAM will be initialized, in short, the external SRAM will be initialized. RAM, and then load the main u-boot into RAM;
as shown below:insert image description here

1. ① in the figure is the loader of SPL in the first stage of u-boot, initializing the most basic hardware, such as closing interrupts, memory initialization, setting the stack and other most basic operations, setting relocation;
2. ② in the figure will Load the main u-boot program, then initialize other board-level hardware, such as network card, nand flash wait, set the commands and environment variables of u-boot itself;
3. In the figure ③ is to load the kernel into RAM, and then start the kernel;

(二)uboot
In Innocent devices, this part is called normal boot, which is similar to the boot used by our other platforms, and the code is open source, and users can customize and modify it.

compile
u-boot can be compiled independently and does not depend on other code. The board configuration file for T31 u-boot is located in include/configs/isvp_t31.h. The compilation command can query the corresponding devices of Ingenious. For example, the command to compile norflash startup for T31X chip is as follows:

make isvp_t31_sfcnor_ddr128M
Compile the uboot command for T31X chip SD card startup as follows:

make isvp_t31_msc0_ddr128M
Compilation steps:
The first step: $ make distclean to clear the old configuration.
The second step: $ make isvp_t31_xxx According to the corresponding chip type (see "Chip Release Notes" for the chip model), compile the corresponding uboot and generate the corresponding u-boot-with-spl .bin

Common Modifications
1) CONFIG_BOOTARGS , the main modification point is the memory configuration and partition size configuration after the kernel is started. (Note: mem means the memory reserved after the kernel is started, rmem means the memory reserved for the SDK (including the memory of the ISP module); the sum of the two is the real memory size of the chip; the specific size can refer to the code)

2) CONFIG_BOOTCOMMAND , configure uboot to start command to execute. For example: Add the sd card startup command in norflash boot
mode, " sf probe;sf read 0x80600000 0x40000 0x280000; bootm 0x80600000 " to " mmc read 0x80600000 0x1800 0x3000; bootm 0x80600000 ".

3) CONFIG_BOOTDELAY, configure the waiting time of uboot.

4) Need to add new norflash chip support.

5) Add password function in uboot:
modify the configuration file, modify isvp_t31.h and add the following content:

#define CONFIG_AUTOBOOT_KEYED // 必配
#define CONFIG_AUTOBOOT_STOP_STR “123456” //必配， uboot 设置的密码。
#define CONFIG_AUTOBOOT_PROMPT “Press xxx in %d second” // bootdelay,选配，

6) SD card upgrade problem
Add #define CONFIG_AUTO_UPDATE definition in isvp_t31.h. The specific code is implemented in common/cmd_sdupdate.c. Points to note: LOAD_ADDR indicates the location where the corresponding memory on the SD card is loaded into the memory. The default setting in the program is 0x82000000. Since this address is located on the uboot heap, the common uboot heap size is set in the configuration of the CONFIG_SYS_MALLOC_LEN macro in isvp_t31.h; so the size of this address that can be used will be limited by the heap size, and Limitation of malloc space in uboot code. (Note: When a larger file needs to be read, CONFIG_SYS_MALLOC_LEN can be appropriately increased)

7) The size of the compiled uboot is larger than the limit . The
default limit in the uboot code is 26Kbytes for the spl part and 214Kbytes for the uboot part; a total of 240Kbytes size limit . If the u-boot-with-spl.bin file generated by uboot compilation is larger than 240Kbytes, it cannot be started.
Solution 1:
Increase the limit of uboot; modify the definition of the CONFIG_SYS_MONITOR_LEN macro in isvp_t31.h; and modify the size of the boot partition and the offset address of the subsequent partitions in the CONFIG_BOOTARGS variable.
Solution two:
If the generated u-boot-with-spl.bin is less than 240Kbytes, you can compress uboot. Modify #undef CONFIG_SPL_LZOP to #define CONFIG_SPL_LZOP in isvp_t31.h; then recompile the burned file name u-boot-lzo-with-spl.bin

8) uboot network problem
The default isvp configuration is the code including the Ethernet part, If the product does not need TFTP download or NFS mount in the uboot stage, the Ethernet part of the code can be cut out to reduce uboot. Specific operation: Open the isvp_T31.h configuration file, and note out the #define CONFIG_CMD_NET macro.

(3) Merger
The spl program officially provided by Ingenuity and the boot.bin compiled and generated by the user need to be merged together and burned into the boot partition at the same time. Ingenea has a merging script, which can be used to convert its own u through build/pad_camera_u-boot.sh -boot pad into boot.bin

usage:./pad_camera_u-boot.sh -i <input_file> -o <output_file> -b <boot.bin fw>
eg:
./pad_camera_u-boot.sh -i u-boot-with-spl.bin -o boot_custom -b ${
    ZRT_ENV_TOP_DIR}/firmware/camera/bootloader/boot.bin
What is executed after the actual command is:

cp ${
    BOOT_FILE} ${
    OUTPUT_FILE}
dd if=${
    INPUT_FILE} of=${
    OUTPUT_FILE} bs=1K skip=${
    UBOOT_OFFSET} seek=${
    UBOOT_OFFSET}
The actual execution content is:
BOOT_FILE is the low-power quick-start firmware that comes with the SDK, take boot_SOC_T31Z_V2.bin as an example

dd  if=u-boot-with-spl.bin  of=boot_custom  bs=1k skip=32 seek=32
if=filename: input filename
of=filename: output filename
bs=bytes: also set the block size of read/output to bytes.
skip=blocks: Skip blocks blocks from the beginning of the input file before starting the copy.
seek=blocks: Skip blocks blocks from the beginning of the output file and start copying.

In fact, the 32K files starting with the boot_SOC_T31Z_V2.bin file and the files after the 32K files in the u-boot-with-spl.bin file are combined to generate a new file.
Reference: https://www.its301.com/article/li_wen01/115245258